Sheriff.controllers.SheriffController = ($xhr, $route, $routeParams )->
  self = @
  Sheriff.sheriffController = self
  $xhr.defaults.headers.post['Content-Type'] = 'application/json'
  $xhr.defaults.headers.put['Content-Type'] = 'application/json'

  # assumes the presence of jQuery
  token = $("meta[name='csrf-token']").attr("content")
  $xhr.defaults.headers.post['X-CSRF-Token'] = token;
  $xhr.defaults.headers.put['X-CSRF-Token'] = token;
  $xhr.defaults.headers['delete']['X-CSRF-Token'] = token;

  <% Sheriff::EXPOSED_MODELS.map{|x| x.pluralize.downcase}.each do |m| %>
  <% full_controller = "Sheriff.controllers.#{m.humanize}Controller" %>
  $route.when('/<%= m %>',
      {template: '<%= asset_path("#{m}/index.html") %>', controller: <%= full_controller %> });
  $route.when('/<%= m %>/show/:<%= m.singularize %>_id',
      {template: '<%= asset_path("#{m}/show.html") %>', controller: <%= full_controller %> });
  <% end %>

  self.$on( '$afterRouteChange', ()->
    console.log('afterRouteChange')
    console.log($routeParams)
  )

  self.$on('$beforeRouteChange', ()->
    console.log("beforeRouteChange")
    console.log($routeParams)
  )

  # $route.onUrlChange ()->
  #   self.params = $route.current.params

  $route.otherwise({redirectTo: '/deputies'});
  $route.parent(@);

Sheriff.controllers.SheriffController.$inject = ['$xhr', '$route', '$routeParams'];

<% Sheriff::EXPOSED_MODELS.each do |model| %>
<% models = model.pluralize %>
Sheriff.controllers.<%= models.humanize %>Controller = ($route, $routeParams, $location, models)->
  self = @
  Sheriff.<%= models.downcase  %>Controller = self
  Sheriff.models = models
  self.$route = $route
  self.$location = $location
  self.$routeParams = $routeParams

  self.currentObject = {}
  # console.log('INIT FOR <%= model %>Controller')

  console.log($route)
  if ($location.hash)
    # console.log($location.$$url)
    self.page =  parseInt($location.$$url.match(/page=\d*/)?[0]?.split('=')?[1])
    self.page = 1 if isNaN(self.page)
    @<%= models.downcase %> = models.<%= models %>.index(page: @page)


  self.show = (object)->
    self.currentObject = object;
    self.location.path('/welcome')
    self.route.reload()
    # angular.service('$browser')(Sheriff.sheriffController).url("http://localhost:3000/#/deputies?page=5")
    ## or use http://docs.angularjs.org/#!/api/angular.widget.ng:include !!!!!!


  self
<%#=  %>
Sheriff.controllers.<%= models %>Controller.$inject = ['$route', '$routeParams', '$location', 'models'];
<% end %>

